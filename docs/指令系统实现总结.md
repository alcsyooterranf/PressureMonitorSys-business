# æŒ‡ä»¤ç³»ç»Ÿå®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºä¸šåŠ¡å¼‚å¸¸ç æšä¸¾ç±»

**æ–‡ä»¶**: `business-types/src/main/java/org/pms/types/constants/BusinessErrorCode.java`

**è¯´æ˜**: 
- ç”±äº`BizCode`è¢«æ”¶å½’åˆ°commonæœåŠ¡ï¼Œåˆ›å»ºäº†æ–°çš„`BusinessErrorCode`æšä¸¾ç±»
- å®šä¹‰äº†æŒ‡ä»¤ç³»ç»Ÿç›¸å…³çš„æ‰€æœ‰å¼‚å¸¸ç 
- åŒ…å«æŒ‡ä»¤å…ƒæ•°æ®ã€æŒ‡ä»¤ä»»åŠ¡ã€æŒ‡ä»¤æ‰§è¡Œã€çŠ¶æ€æµè½¬ç­‰å¼‚å¸¸

**å¼‚å¸¸ç åˆ†ç±»**:
- `ERR_BIZ_COMMAND_META_3xxx`: æŒ‡ä»¤å…ƒæ•°æ®ç›¸å…³å¼‚å¸¸
- `ERR_BIZ_COMMAND_TASK_5xxx`: æŒ‡ä»¤ä»»åŠ¡ç›¸å…³å¼‚å¸¸
- `ERR_BIZ_COMMAND_EXECUTION_5xxx`: æŒ‡ä»¤æ‰§è¡Œç›¸å…³å¼‚å¸¸
- `ERR_BIZ_COMMAND_STATE_4xxx`: æŒ‡ä»¤çŠ¶æ€æµè½¬ç›¸å…³å¼‚å¸¸

---

### 2. å®ç°æŒ‡ä»¤å“åº”å¤„ç†æœåŠ¡

**æ–‡ä»¶**: `business-application/src/main/java/org/pms/application/service/CommandRespHandler.java`

**èŒè´£**:
1. æ¥æ”¶ç½‘å…³æ¨é€çš„æŒ‡ä»¤å“åº”
2. æ›´æ–°æŒ‡ä»¤æ‰§è¡Œè®°å½•ï¼ˆç»“æœå’Œå›è°ƒä¿¡æ¯ï¼‰
3. è§¦å‘çŠ¶æ€æœºæµè½¬

**æ ¸å¿ƒæ–¹æ³•**:
```java
public void handleCommandResponse(Long aepTaskId, Long deviceId, 
                                   CommandState commandState,
                                   JsonNode commandResult, 
                                   String rawCallback)
```

**å¤„ç†æµç¨‹**:
1. æ ¹æ®`aepTaskId`å’Œ`deviceId`æŸ¥è¯¢å½“å‰æ‰§è¡Œè®°å½•
2. æ›´æ–°`result_detail`å’Œ`last_raw_callback`å­—æ®µ
3. æ ¹æ®`commandState`è§¦å‘å¯¹åº”çš„çŠ¶æ€æµè½¬æ–¹æ³•

---

### 3. å®Œå–„RPCæ¥å£å®ç°

**æ–‡ä»¶**: `business-trigger/src/main/java/org/pms/trigger/facade/CommandFacade.java`

**ä¿®æ”¹å†…å®¹**:
- ç§»é™¤äº†æœªä½¿ç”¨çš„`ApiToDomainConverter`ä¾èµ–
- å®ç°äº†`handleCommandResp()`æ–¹æ³•ï¼Œè°ƒç”¨`CommandRespHandler`
- å®ç°äº†`batchHandleCommandResp()`æ–¹æ³•ï¼Œæ‰¹é‡å¤„ç†æŒ‡ä»¤å“åº”

**æ¥å£è¯´æ˜**:
- `POST /api/device/command/save`: å•æ¡æŒ‡ä»¤å“åº”å¤„ç†
- `POST /api/device/command/batch-save`: æ‰¹é‡æŒ‡ä»¤å“åº”å¤„ç†

---

### 4. å®Œå–„ä½¿ç”¨æ–‡æ¡£

**æ–‡ä»¶**: `docs/æŒ‡ä»¤ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`

**æ–°å¢å†…å®¹**:
- **ç¬¬ä¸ƒç« ï¼šå®Œæ•´ä»£ç ç¤ºä¾‹**
  - æŒ‡ä»¤ä¸‹å‘å®Œæ•´æµç¨‹ä»£ç 
  - ç½‘å…³å›è°ƒå¤„ç†æµç¨‹ä»£ç 
  - çŠ¶æ€æµè½¬ç¤ºä¾‹ä»£ç 
  
- **ç¬¬å…«ç« ï¼šæ¶æ„å›¾**
  - å®Œæ•´è°ƒç”¨é“¾è·¯å›¾ï¼ˆä»å‰ç«¯åˆ°æ•°æ®åº“ï¼‰
  - æ¸…æ™°å±•ç¤ºå„å±‚èŒè´£
  
- **ç¬¬ä¹ç« ï¼šæ€»ç»“**
  - æ ¸å¿ƒè¦ç‚¹æ€»ç»“
  - å…³é”®ç‚¹æé†’

---

## ğŸ“Š å®Œæ•´è°ƒç”¨é“¾è·¯

### æŒ‡ä»¤ä¸‹å‘æµç¨‹

```
å‰ç«¯ â†’ CommandController â†’ CommandTaskService â†’ AepCommandClient â†’ AEPå¹³å° â†’ è®¾å¤‡
```

### æŒ‡ä»¤å“åº”æµç¨‹ï¼ˆé‡ç‚¹ï¼‰

```
è®¾å¤‡ â†’ AEPå¹³å° â†’ ç½‘å…³ â†’ CommandFacade (RPCæ¥å£)
    â†’ CommandRespHandler (åº”ç”¨å±‚æœåŠ¡)
    â†’ StateHandler (çŠ¶æ€æœº)
    â†’ æ›´æ–°MySQLæ•°æ®åº“
```

---

## ğŸ¯ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. CommandFacade (Triggerå±‚)
- **èŒè´£**: æä¾›RPCæ¥å£ï¼Œæ¥æ”¶ç½‘å…³æ¨é€çš„æŒ‡ä»¤å“åº”
- **ä½ç½®**: `business-trigger/src/main/java/org/pms/trigger/facade/CommandFacade.java`
- **æ¥å£**: 
  - `POST /api/device/command/save` - å•æ¡å“åº”
  - `POST /api/device/command/batch-save` - æ‰¹é‡å“åº”

### 2. CommandRespHandler (Applicationå±‚)
- **èŒè´£**: å¤„ç†æŒ‡ä»¤å“åº”ï¼Œæ›´æ–°æ‰§è¡Œè®°å½•ï¼Œè§¦å‘çŠ¶æ€æµè½¬
- **ä½ç½®**: `business-application/src/main/java/org/pms/application/service/CommandRespHandler.java`
- **æ ¸å¿ƒæ–¹æ³•**: `handleCommandResponse()`

### 3. StateHandler (Domainå±‚)
- **èŒè´£**: çŠ¶æ€æœºæµè½¬ï¼ŒéªŒè¯çŠ¶æ€æµè½¬åˆæ³•æ€§
- **ä½ç½®**: `business-domain/src/main/java/org/pms/domain/command/service/stateflow/IStateHandler.java`
- **æ–¹æ³•**: `saved()`, `sent()`, `delivered()`, `completed()`, `timeout()`, `ttlTimeout()`

### 4. BusinessErrorCode (Typeså±‚)
- **èŒè´£**: å®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç 
- **ä½ç½®**: `business-types/src/main/java/org/pms/types/constants/BusinessErrorCode.java`
- **ç”¨é€”**: ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œä¾¿äºé—®é¢˜å®šä½

---

## ğŸ” ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šä¸‹å‘æŒ‡ä»¤å¹¶æ¥æ”¶å“åº”

#### æ­¥éª¤1ï¼šåˆ›å»ºæŒ‡ä»¤ä»»åŠ¡
```bash
POST /command/task/create
{
  "pipelineId": 17087544,
  "serviceIdentifier": "test_command",
  "args": "{\"syn\":\"tongbu\",\"test_attr\":11}",
  "tenantId": "tenant_001"
}

# å“åº”
{
  "code": "SUCCESS",
  "data": 1  // taskId
}
```

#### æ­¥éª¤2ï¼šä¸‹å‘æŒ‡ä»¤
```bash
POST /command/task/send-async
{
  "taskId": 1,
  "deviceId": 1,
  "deviceSN": 1708754401,
  "pipelineId": 17087544
}
```

#### æ­¥éª¤3ï¼šç½‘å…³æ¥æ”¶AEPå›è°ƒå¹¶æ¨é€ç»™åç«¯
```bash
# ç½‘å…³è°ƒç”¨åç«¯RPCæ¥å£
POST /api/device/command/save
{
  "deviceId": "1708754401",
  "pipelineId": "17087544",
  "taskId": 64,
  "commandState": "DELIVERED",
  "commandResult": {"status": "success"},
  "timestamp": 1734567890000,
  "tenantId": "tenant_001"
}
```

#### æ­¥éª¤4ï¼šåç«¯è‡ªåŠ¨å¤„ç†
- `CommandFacade`æ¥æ”¶RPCè¯·æ±‚
- è°ƒç”¨`CommandRespHandler.handleCommandResponse()`
- æ›´æ–°`t_command_execution`è¡¨çš„`result_detail`å’Œ`last_raw_callback`
- è§¦å‘çŠ¶æ€æœºï¼š`StateHandler.delivered()`
- æ›´æ–°`status`å­—æ®µä¸º`DELIVERED`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼‚å¸¸ç ä½¿ç”¨**: 
   - é¡¹ç›®ä¸­ä½¿ç”¨`BusinessErrorCode`è€Œä¸æ˜¯`BizCode`
   - åç»­æ‚¨å¯ä»¥å°†`BusinessErrorCode`é‡å‘½åæˆ–åˆå¹¶åˆ°commonæœåŠ¡çš„`BizCode`

2. **çŠ¶æ€æµè½¬è§„åˆ™**:
   - å¿…é¡»æŒ‰ç…§è§„å®šçš„æµè½¬è·¯å¾„è¿›è¡Œ
   - ç»ˆæ€ï¼ˆCOMPLETEDã€TIMEOUTã€TTL_TIMEOUTï¼‰ä¸å¯å†æµè½¬
   - éæ³•æµè½¬ä¼šæŠ›å‡º`BizException`

3. **ç½‘å…³é›†æˆ**:
   - ç½‘å…³éœ€è¦å®ç°AEPå›è°ƒæ¥æ”¶
   - ç½‘å…³éœ€è¦è°ƒç”¨åç«¯RPCæ¥å£`/api/device/command/save`
   - å»ºè®®ä½¿ç”¨Feign Clientè¿›è¡ŒRPCè°ƒç”¨

4. **æ•°æ®åº“å­—æ®µ**:
   - `aep_task_id`: AEPå¹³å°è¿”å›çš„commandId
   - `last_raw_callback`: å­˜å‚¨å®Œæ•´çš„å›è°ƒJSONï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
   - `result_detail`: å­˜å‚¨è®¾å¤‡è¿”å›çš„æ‰§è¡Œç»“æœ

---

## ğŸ“ åç»­å·¥ä½œå»ºè®®

1. **æµ‹è¯•éªŒè¯**:
   - ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯çŠ¶æ€æµè½¬é€»è¾‘
   - é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´è°ƒç”¨é“¾è·¯
   - å‹åŠ›æµ‹è¯•éªŒè¯å¹¶å‘å¤„ç†èƒ½åŠ›

2. **ç›‘æ§å‘Šè­¦**:
   - æ·»åŠ æŒ‡ä»¤æ‰§è¡Œè¶…æ—¶ç›‘æ§
   - æ·»åŠ çŠ¶æ€æµè½¬å¤±è´¥å‘Šè­¦
   - è®°å½•å…³é”®æŒ‡æ ‡ï¼ˆæˆåŠŸç‡ã€å¹³å‡å“åº”æ—¶é—´ç­‰ï¼‰

3. **ä¼˜åŒ–æ”¹è¿›**:
   - è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ç½‘å…³å’Œåç«¯
   - å®ç°æŒ‡ä»¤é‡è¯•æœºåˆ¶
   - æ·»åŠ æŒ‡ä»¤æ‰§è¡Œå†å²è®°å½•

---

æ‰€æœ‰åŠŸèƒ½å·²å®ç°å®Œæˆï¼ğŸ‰

